name: deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: configure python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'

      - name: checkout tunebook
        uses: actions/checkout@v2

      - name: install dependencies
        run: | 
          pip install sphinx
          pip install sphinx_rtd_theme

      - name: checkout gh-pages
        uses: actions/checkout@v2
        with:
          ref: gh-pages
          path: gh-pages

      - name: sync static files
        if: ${{ github.event.inputs.set_stable }}
        run: |
          DOCS="${{ github.workspace }}/docs" \
          PAGE="${{ github.workspace }}/gh-pages"  \

          rsync -r "$DOCS/doc/" "$PAGE/"

      - name: install gh-pages
        run: |
          DOCS="${{ github.workspace }}/docs" \
          PAGE="${{ github.workspace }}/gh-pages"  \

          cd "$DOCS"
          rm -r doc
          ln -s "$PAGE" doc

      - name: build docs
        run: |
          # NOTE: Doing a clean build allows up to update docs for a
          #       deployed version at a later date.
          make -C docs \
            clean \
            html \
            singlepage \
            linkcheck \
            SPHINXOPTS='-Wn' \
            STABLE=${{ github.event.inputs.set_stable }} \
            LATEST=${{ github.event.inputs.set_latest }}

      - name: configure git
        uses: cylc/release-actions/configure-git@v1

      - name: push changes
        run: |
          cd gh-pages
          git add *
          git commit -m "add: updated docs"
          git push origin HEAD
